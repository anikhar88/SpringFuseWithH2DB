/*
 * (c) Copyright 2005-2015 JAXIO, http://www.jaxio.com
 * Source code generated by Celerio, a Jaxio product
 * Want to purchase Celerio ? email us at info@jaxio.com
 * Follow us on twitter: @springfuse
 * Documentation: http://www.jaxio.com/documentation/celerio/
 * Template pack-backend-jpa:src/main/java/audit/HibernateListenerRegistration.p.vm.java
 */
package com.h2.demo.audit;

import static com.h2.demo.service.AuditEvent.ApplicationShutdown;
import static com.h2.demo.service.AuditEvent.ApplicationStartup;
import static org.hibernate.event.spi.EventType.POST_DELETE;
import static org.hibernate.event.spi.EventType.POST_INSERT;
import static org.hibernate.event.spi.EventType.PRE_UPDATE;

import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;
import javax.inject.Inject;
import javax.inject.Named;

import org.hibernate.SessionFactory;
import org.hibernate.event.service.spi.EventListenerRegistry;
import org.hibernate.event.spi.EventType;
import org.hibernate.internal.SessionFactoryImpl;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Lazy;

import com.h2.demo.service.AuditLogService;

@Named
@Lazy(false)
public class HibernateListenerRegistration {
    private static final Logger log = LoggerFactory.getLogger(HibernateListenerRegistration.class);

    @Inject
    private AuditLogService auditLogService;
    @Inject
    private SessionFactory sessionFactory;
    @Inject
    private AuditLogListener auditLogListener;

    @PostConstruct
    public void registerListeners() {
        register(POST_DELETE, auditLogListener);
        register(POST_INSERT, auditLogListener);
        register(PRE_UPDATE, auditLogListener);
        auditLogService.event(ApplicationStartup);
    }

    private <T> void register(EventType<T> eventType, T t) {
        EventListenerRegistry registry = ((SessionFactoryImpl) sessionFactory).getServiceRegistry().getService(EventListenerRegistry.class);
        log.info("Registering {} listener on {} events", t.getClass(), eventType);
        registry.getEventListenerGroup(eventType).appendListener(t);
    }

    @PreDestroy
    public void destroy() {
        auditLogService.event(ApplicationShutdown);
    }
}